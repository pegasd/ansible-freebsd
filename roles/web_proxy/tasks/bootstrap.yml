---
- name: Nginx and certbot packages
  community.general.pkgng:
    name: '{{ item }}'
    state: present
  loop:
    - nginx
    - 'py{{ web_proxy_python_version | replace(".", "") }}-certbot'
    - 'py{{ web_proxy_python_version | replace(".", "") }}-certbot-nginx'

- name: Enable nginx at startup
  ansible.builtin.service:
    name: nginx_enable
    value: 'YES'
  notify: Restart nginx

- name: VHost nginx directories
  ansible.builtin.file:
    state: directory
    owner: root
    group: wheel
    mode: '0755'
    path: '{{ web_proxy_nginx_conf_directory }}/vhosts'

- name: Nginx configuration
  ansible.builtin.template:
    src: nginx.conf.j2
    dest: '{{ web_proxy_nginx_conf_directory }}/nginx.conf'
    owner: root
    group: wheel
    mode: '0644'
  notify: Restart nginx

- name: Generate DH parameters
  ansible.builtin.command:
    cmd: 'openssl dhparam -out {{ web_proxy_nginx_conf_directory }}/dhparam.pem 2048'
    creates: '{{ web_proxy_nginx_conf_directory }}/dhparam.pem'
  notify: Restart nginx

- name: Copy SSL nginx options
  ansible.builtin.copy:
    mode: preserve
    remote_src: true
    src: '/usr/local/lib/python{{ web_proxy_python_version }}/site-packages/certbot_nginx/_internal/tls_configs/options-ssl-nginx.conf'
    dest: '{{ web_proxy_nginx_conf_directory }}/options-ssl-nginx.conf'
  notify: Restart nginx
...

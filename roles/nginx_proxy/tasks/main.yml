---
- include_tasks: bootstrap.yml
  when: enable_bootstrap

- include_tasks: bootstrap-standalone.yml
  when: cert_create_method == 'standalone'

- include_tasks: bootstrap-cloudflare.yml
  when: cert_create_method == 'cloudflare'

- include_tasks: generate-cert-standalone.yml
  with_items: '{{ vhosts }}'
  when:
    - cert_create_if_missing
    - cert_create_method == 'standalone'
  loop_control:
    loop_var: vhost

- include_tasks: generate-cert-cloudflare.yml
  with_items: '{{ vhosts }}'
  when:
    - cert_create_if_missing
    - cert_create_method == 'cloudflare'
  loop_control:
    loop_var: vhost

- include_tasks: vhost-proxy.yml
  with_items: '{{ vhosts }}'
  loop_control:
    loop_var: vhost

- import_tasks: renew-cron.yml

- name: Restart nginx after all changes
  ansible.builtin.service:
    name: nginx
    state: restarted
  when: restart_nginx and
        (
          (enable_bootstrap and (rc_enable.changed or config.changed or dhparam.changed or ssl_options.changed))
          or (sa_certgen_changed is defined and sa_certgen_changed)
          or (cf_certgen_changed is defined and cf_certgen_changed)
          or (vhost_config_changed is defined and vhost_config_changed)
        )
...
